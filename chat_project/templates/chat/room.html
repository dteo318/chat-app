{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ room_name }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{% static 'css/room.css' %}" />
  </head>
  <nav>
    <div class="dropdown dropdown-spacing">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="users-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Users
      </button>
      <div class="dropdown-menu" id="users-menu" aria-labelledby="dropdownMenuButton">
        <!-- Populated using Ajax requests -->
      </div>
    </div>
  </div>
  </nav>
  <body onunload="chatClosed()">
    <div class="container shadow-style">
      <div class="chat-box messages" id="chat-log">
        <p class="start-message">You may begin sending messages...</p>
      </div>
      <div class="input-group">
        <span class="input-group-text">Message</span>
        <textarea
          class="form-control"
          aria-label="Message"
          rows="3"
          id="chat-message-input"
        ></textarea>
        <button type="button" id="chat-message-submit" class="btn btn-style">
          Submit
        </button>
      </div>
    </div>
    {{ room_name|json_script:"room-name" }}
    <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
    <script>
      const roomName = JSON.parse(
        document.getElementById("room-name").textContent
      );

      const current_user = localStorage.getItem("user-name");

      const chatSocket = new WebSocket(
        "ws://" + window.location.host + "/ws/" + current_user + '/' + roomName + "/"
      );

      chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const chat_box = document.querySelector("#chat-log");

        const message_elem = document.createElement("P");
        const username_elem = document.createElement("STRONG");
        const message = document.createTextNode(data.message);
        const username = document.createTextNode(data.username + ": ");

        username_elem.appendChild(username);
        message_elem.appendChild(username_elem);
        message_elem.appendChild(message);

        chat_box.appendChild(message_elem);

        chat_box.scrollTop = chat_box.scrollHeight;
      };

      function chatClosed() {

        chatSocket.send(
          JSON.stringify({
            username: 'ADMIN',
            message: `${current_user} has left the chat...`,
          })
        );

        $.ajax({
          url: '/ajax/removeUser',
          data: {
            'user' : current_user,
            'room' : roomName
          },
          dataType: 'json',
          success: function (data) {
            console.log("User logged out");
          }
        });
      }

      chatSocket.onclose = function (e) {
        console.error("Chat socket closed unexpectedly");
      };

      document.querySelector("#chat-message-input").focus();
      document.querySelector("#chat-message-input").onkeyup = function (e) {
        if (e.keyCode === 13) {
          // enter, return
          document.querySelector("#chat-message-submit").click();
        }
      };

      document.querySelector("#chat-message-submit").onclick = function (e) {
        const messageInputDom = document.querySelector("#chat-message-input");
        const message = messageInputDom.value;

        chatSocket.send(
          JSON.stringify({
            username: current_user,
            message: message,
          })
        );
        messageInputDom.value = "";
      };

      $("#users-button").click(function () {
        $.ajax({
          url: '/ajax/getUsers',
          data: {
            'room' : roomName
          },
          dataType: 'json',
          success: function (data) {
            const user_menu = document.querySelector('#users-menu');

            user_menu.innerHTML = '';
            user_data = JSON.parse(data.room_connections)

            user_data.forEach(function (user, index) {
              let username_elem = document.createElement('A');
              username_elem.className = 'dropdown-item inactiveLink'
              username = user.fields.username

              if (username == current_user) {
                let current_user_bold = document.createElement('STRONG');
                current_user_bold.innerHTML = username;
                username_elem.appendChild(current_user_bold);
              } else {
                username_elem.innerHTML = username;
              }
              user_menu.appendChild(username_elem);
            });
          }
        });
      });
    </script>
  </body>
</html>